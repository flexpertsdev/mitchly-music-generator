<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate Audio V2 - Test Interface</title>
  <link rel="stylesheet" href="https://unpkg.com/@appwrite.io/pink@0" />
  <link rel="stylesheet" href="https://unpkg.com/@appwrite.io/pink-icons@0" />
  <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body class="theme-dark">
  <main class="main-content">
    <div class="top-cover u-padding-block-end-56">
      <div class="container">
        <h1 class="heading-level-1 u-margin-block-start-16">Generate Audio Function V2</h1>
        <p class="body-text-1 u-normal u-margin-block-start-8" style="max-width: 50rem">
          Test the audio generation function. Enter a song ID that has lyrics to generate
          AI-powered audio tracks using the Mureka API.
        </p>
      </div>
    </div>
    
    <div x-data="audioGenerator()" class="container u-margin-block-start-negative-56">
      <div class="card u-flex u-gap-24 u-flex-vertical">
        <div>
          <h2 class="heading-level-4">Generate Audio</h2>
          <p class="text u-margin-block-start-8">
            Enter the ID of a song that has lyrics. The function will generate an audio track
            based on the lyrics and band style.
          </p>
          
          <div class="u-margin-block-start-16">
            <label class="label">Song ID</label>
            <input 
              x-model="songId"
              type="text"
              class="input-text"
              placeholder="Enter song document ID"
              :disabled="isGenerating"
            />
          </div>
          
          <div class="u-margin-block-start-16">
            <label class="form-label">
              <input 
                x-model="waitForCompletion"
                type="checkbox"
                class="input-checkbox"
                :disabled="isGenerating"
              />
              <span class="text">Wait for completion (max 30 seconds)</span>
            </label>
          </div>
          
          <button 
            @click="generateAudio()"
            class="button u-margin-block-start-16"
            :disabled="!songId || isGenerating"
          >
            <span class="text" x-text="isGenerating ? 'Generating...' : 'Generate Audio'"></span>
          </button>
          
          <template x-if="taskId && isPolling">
            <div class="u-margin-block-start-16">
              <div class="alert is-info">
                <div class="alert-grid">
                  <span class="icon-loader" aria-hidden="true"></span>
                  <div class="alert-content">
                    <h6 class="alert-title">Processing</h6>
                    <p class="alert-message">Task ID: <span x-text="taskId"></span></p>
                    <p class="alert-message" x-text="`Progress: ${progress}%`"></p>
                  </div>
                </div>
              </div>
              <button 
                @click="checkStatus()"
                class="button is-secondary u-margin-block-start-8"
              >
                <span class="text">Check Status</span>
              </button>
            </div>
          </template>
          
          <template x-if="error">
            <div class="alert is-danger u-margin-block-start-16">
              <div class="alert-grid">
                <span class="icon-x-circle" aria-hidden="true"></span>
                <div class="alert-content">
                  <h6 class="alert-title">Error</h6>
                  <p class="alert-message" x-text="error"></p>
                </div>
              </div>
            </div>
          </template>
          
          <template x-if="result">
            <div class="u-margin-block-start-24">
              <h3 class="heading-level-5">Generation Result</h3>
              
              <template x-if="audioUrl">
                <div class="u-margin-block-start-16">
                  <h4 class="heading-level-6">Generated Audio</h4>
                  <audio controls class="u-margin-block-start-8" style="width: 100%;">
                    <source :src="audioUrl" type="audio/mpeg">
                    Your browser does not support the audio element.
                  </audio>
                  <p class="text u-margin-block-start-4">
                    <a :href="audioUrl" target="_blank" class="link">Download Audio</a>
                  </p>
                </div>
              </template>
              
              <div class="u-margin-block-start-16">
                <h4 class="heading-level-6">Response Data</h4>
                <div class="card u-margin-block-start-8" style="background: #1a1a1a;">
                  <pre class="u-text-wrap" style="color: #e0e0e0; font-size: 0.875rem;"><code x-text="JSON.stringify(result, null, 2)"></code></pre>
                </div>
              </div>
            </div>
          </template>
        </div>
        
        <div class="u-sep-block"></div>
        
        <div>
          <h3 class="heading-level-5">API Usage</h3>
          <p class="text u-margin-block-start-8">
            Send a POST request to this function with the following JSON body:
          </p>
          <div class="code-block u-margin-block-start-8">
            <pre>{
  "songId": "your-song-document-id",
  "waitForCompletion": false  // Optional, waits up to 30s
}</pre>
          </div>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Response (Immediate)</h4>
          <div class="code-block u-margin-block-start-8">
            <pre>{
  "success": true,
  "songId": "song-id",
  "message": "Audio generation started",
  "taskId": "task-id",
  "status": "processing"
}</pre>
          </div>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Response (With Completion)</h4>
          <div class="code-block u-margin-block-start-8">
            <pre>{
  "success": true,
  "songId": "song-id",
  "message": "Audio generated successfully",
  "audioUrl": "https://...",
  "duration": 180
}</pre>
          </div>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Database Event Trigger</h4>
          <p class="text u-margin-block-start-8">
            This function can also be triggered automatically when a song document
            is created or updated with <code class="inline-code">status: "generating_audio"</code>
          </p>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Environment Variables</h4>
          <ul class="list u-margin-block-start-8">
            <li>MUREKA_API_KEY - Required for audio generation</li>
            <li>APPWRITE_FUNCTION_API_KEY - Required for database access</li>
          </ul>
        </div>
      </div>
      
      <div class="card u-margin-block-start-24">
        <h3 class="heading-level-5">Check Audio Status</h3>
        <p class="text u-margin-block-start-8">
          Enter a task ID to check the status of an audio generation task.
        </p>
        
        <div class="u-margin-block-start-16">
          <label class="label">Task ID</label>
          <input 
            x-model="checkTaskId"
            type="text"
            class="input-text"
            placeholder="Enter task ID from generation"
          />
        </div>
        
        <button 
          @click="checkTaskStatus()"
          class="button u-margin-block-start-16"
          :disabled="!checkTaskId"
        >
          <span class="text">Check Status</span>
        </button>
        
        <template x-if="statusResult">
          <div class="u-margin-block-start-16">
            <div class="card" style="background: #1a1a1a;">
              <pre class="u-text-wrap" style="color: #e0e0e0; font-size: 0.875rem;"><code x-text="JSON.stringify(statusResult, null, 2)"></code></pre>
            </div>
          </div>
        </template>
      </div>
    </div>
  </main>
  
  <script>
    function audioGenerator() {
      return {
        songId: '',
        waitForCompletion: false,
        isGenerating: false,
        isPolling: false,
        result: null,
        error: null,
        audioUrl: null,
        taskId: null,
        progress: 0,
        checkTaskId: '',
        statusResult: null,
        
        async generateAudio() {
          this.isGenerating = true;
          this.error = null;
          this.result = null;
          this.audioUrl = null;
          this.taskId = null;
          this.progress = 0;
          
          try {
            const response = await fetch('/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                songId: this.songId,
                waitForCompletion: this.waitForCompletion
              })
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
              throw new Error(data.error || 'Generation failed');
            }
            
            this.result = data;
            
            if (data.audioUrl) {
              this.audioUrl = data.audioUrl;
            } else if (data.taskId) {
              this.taskId = data.taskId;
              this.isPolling = true;
              // Auto-check status after a few seconds
              setTimeout(() => this.checkStatus(), 5000);
            }
          } catch (err) {
            this.error = err.message;
          } finally {
            this.isGenerating = false;
          }
        },
        
        async checkStatus() {
          if (!this.taskId) return;
          
          // For demo purposes, simulate checking status
          // In production, you'd call a separate status endpoint
          this.progress = Math.min(this.progress + 20, 95);
          
          if (this.progress >= 95) {
            this.isPolling = false;
            this.audioUrl = 'https://example.com/generated-audio.mp3';
            this.result = {
              ...this.result,
              status: 'completed',
              audioUrl: this.audioUrl
            };
          } else {
            setTimeout(() => this.checkStatus(), 5000);
          }
        },
        
        async checkTaskStatus() {
          this.statusResult = null;
          
          try {
            // This would call a separate check-status function
            // For now, return mock data
            this.statusResult = {
              taskId: this.checkTaskId,
              status: 'processing',
              progress: 65,
              message: 'Audio generation in progress...'
            };
          } catch (err) {
            this.error = err.message;
          }
        }
      };
    }
  </script>
</body>
</html>