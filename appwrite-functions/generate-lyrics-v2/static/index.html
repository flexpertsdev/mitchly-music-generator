<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate Lyrics V2 - Test Interface</title>
  <link rel="stylesheet" href="https://unpkg.com/@appwrite.io/pink@0" />
  <link rel="stylesheet" href="https://unpkg.com/@appwrite.io/pink-icons@0" />
  <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body class="theme-dark">
  <main class="main-content">
    <div class="top-cover u-padding-block-end-56">
      <div class="container">
        <h1 class="heading-level-1 u-margin-block-start-16">Generate Lyrics Function V2</h1>
        <p class="body-text-1 u-normal u-margin-block-start-8" style="max-width: 50rem">
          Test the lyrics generation function. Enter a song ID from your database to generate
          AI-powered lyrics based on the song and band context.
        </p>
      </div>
    </div>
    
    <div x-data="lyricsGenerator()" class="container u-margin-block-start-negative-56">
      <div class="card u-flex u-gap-24 u-flex-vertical">
        <div>
          <h2 class="heading-level-4">Generate Lyrics</h2>
          <p class="text u-margin-block-start-8">
            Enter the ID of a song that needs lyrics. The function will fetch the song
            details and generate appropriate lyrics.
          </p>
          
          <div class="u-margin-block-start-16">
            <label class="label">Song ID</label>
            <input 
              x-model="songId"
              type="text"
              class="input-text"
              placeholder="Enter song document ID"
              :disabled="isGenerating"
            />
          </div>
          
          <button 
            @click="generateLyrics()"
            class="button u-margin-block-start-16"
            :disabled="!songId || isGenerating"
          >
            <span class="text" x-text="isGenerating ? 'Generating...' : 'Generate Lyrics'"></span>
          </button>
          
          <template x-if="error">
            <div class="alert is-danger u-margin-block-start-16">
              <div class="alert-grid">
                <span class="icon-x-circle" aria-hidden="true"></span>
                <div class="alert-content">
                  <h6 class="alert-title">Error</h6>
                  <p class="alert-message" x-text="error"></p>
                </div>
              </div>
            </div>
          </template>
          
          <template x-if="result">
            <div class="u-margin-block-start-24">
              <h3 class="heading-level-5">Generation Result</h3>
              
              <div class="u-margin-block-start-16">
                <h4 class="heading-level-6">Song Description</h4>
                <p class="text u-margin-block-start-4" x-text="songDescription || 'No description'"></p>
              </div>
              
              <div class="u-margin-block-start-16">
                <h4 class="heading-level-6">Generated Lyrics</h4>
                <div class="card u-margin-block-start-8" style="background: #1a1a1a;">
                  <pre class="u-text-wrap" style="color: #e0e0e0; font-size: 0.875rem; white-space: pre-wrap;"><code x-text="lyrics"></code></pre>
                </div>
              </div>
              
              <div class="u-margin-block-start-16">
                <h4 class="heading-level-6">Response Data</h4>
                <div class="card u-margin-block-start-8" style="background: #1a1a1a;">
                  <pre class="u-text-wrap" style="color: #e0e0e0; font-size: 0.875rem;"><code x-text="JSON.stringify(result, null, 2)"></code></pre>
                </div>
              </div>
            </div>
          </template>
        </div>
        
        <div class="u-sep-block"></div>
        
        <div>
          <h3 class="heading-level-5">API Usage</h3>
          <p class="text u-margin-block-start-8">
            Send a POST request to this function with the following JSON body:
          </p>
          <div class="code-block u-margin-block-start-8">
            <pre>{
  "songId": "your-song-document-id"
}</pre>
          </div>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Response</h4>
          <div class="code-block u-margin-block-start-8">
            <pre>{
  "success": true,
  "songId": "song-id",
  "message": "Lyrics generated successfully",
  "preview": "First 100 characters..."
}</pre>
          </div>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Database Event Trigger</h4>
          <p class="text u-margin-block-start-8">
            This function can also be triggered automatically when a song document
            is created or updated with <code class="inline-code">status: "generating_lyrics"</code>
          </p>
          
          <h4 class="heading-level-6 u-margin-block-start-16">Environment Variables</h4>
          <ul class="list u-margin-block-start-8">
            <li>ANTHROPIC_API_KEY - Required for AI generation</li>
            <li>APPWRITE_FUNCTION_API_KEY - Required for database access</li>
          </ul>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    function lyricsGenerator() {
      return {
        songId: '',
        isGenerating: false,
        result: null,
        error: null,
        lyrics: '',
        songDescription: '',
        
        async generateLyrics() {
          this.isGenerating = true;
          this.error = null;
          this.result = null;
          this.lyrics = '';
          this.songDescription = '';
          
          try {
            const response = await fetch('/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                songId: this.songId
              })
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
              throw new Error(data.error || 'Generation failed');
            }
            
            this.result = data;
            
            // Try to fetch the updated song to show the lyrics
            // This is just for display in the test interface
            if (data.success) {
              await this.fetchSongLyrics();
            }
          } catch (err) {
            this.error = err.message;
          } finally {
            this.isGenerating = false;
          }
        },
        
        async fetchSongLyrics() {
          // In a real scenario, you'd fetch from Appwrite
          // For now, we'll just show what was returned
          this.lyrics = 'Lyrics have been saved to the song document.\nCheck your Appwrite console to see the full lyrics.';
          this.songDescription = 'Song description has been saved.';
        }
      };
    }
  </script>
</body>
</html>